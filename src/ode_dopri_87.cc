//! \file ode_dopri_87.cc

#include "ode_dopri_87.h"

namespace ode {

OdeDoPri87::OdeDoPri87 (unsigned long neq) :
    OdeEmbedded (neq, false, 7),
    OdeRK (neq, 13),
    OdeERK (neq) {

    method_ = "DoPri87";
    //tableau of coefficents
    c2 =                   1.0/18; a21 =                       c2;
    c3 =                   1.0/12; a31 =                   1.0/48; a32 = 1.0/16;
    c4 =                    1.0/8; a41 =                   1.0/32;               a43 =   3.0/32;
    c5 =                   5.0/16; a51 =                   5.0/16;               a53 = -75.0/64; a54 =                     75.0/64;
    c6 =                    3.0/8; a61 =                   3.0/80;                               a64 =                      3.0/16; a65 =                   3.0/20;
    c7 =                 59.0/400; a71 =     29443841.0/614563906;                               a74 =        77736538.0/692538347; a75 =   -28693883.0/1125000000; a76 =      23124283.0/1800000000;
    c8 =                 93.0/200; a81 =     16016141.0/946692911;                               a84 =        61564180.0/158732637; a85 =     22789713.0/633445777; a86 =     545815736.0/2771057229; a87 =    -180193667.0/1043307555;
    c9 =  5490023248.0/9719169821; a91 =     39632708.0/573591083;                               a94 =      -433636366.0/683701615; a95 =  -421739975.0/2616292301; a96 =      100302831.0/723423059; a97 =      790204164.0/839813087; a98 =     800635310.0/3783071287;
    c10 =                 13.0/20; a101 =  246121993.0/1340847787;                               a104 = -37695042795.0/15268766246; a105 = -309121744.0/1061227803; a106 =     -12992083.0/490766935; a107 =   6005943493.0/2108947869; a108 =    393006217.0/1396673457; a109 =    123872331.0/1001029789;
    c11 = 1201146811.0/1299019798; a111 = -1028468189.0/846180014;                               a114 =     8478235783.0/508512852; a115 = 1311729495.0/1432422823; a116 = -10304129995.0/1701304382; a117 = -48777925059.0/3047939560; a118 =  15336726248.0/1032824649; a119 = -45442868181.0/3398467696; a1110 =  3065993473.0/597172653;
    c12 =                     1.0; a121 =   185892177.0/718116043;                               a124 =    -3185094517.0/667107341; a125 = -477755414.0/1098053517; a126 =    -703635378.0/230739211; a127 =   5731566787.0/1027545527; a128 =    5232866602.0/850066563; a129 =   -4093664535.0/808688257; a1210 = 3962137247.0/1805957418; a1211 =   65686358.0/487910083;
    c13 =                     1.0; a131 =   403863854.0/491063109;                               a134 =    -5068492393.0/434740067; a135 =  -411421997.0/543043805; a136 =     652783627.0/914296604; a137 =   11173962825.0/925320556; a138 = -13158990841.0/6184727034; a139 =   3936647629.0/1978049680; a1310 =  -160528059.0/685178525; a1311 = 248638103.0/1413531060;
                                   b1 =      14005451.0/335480064;                                                                                                    b6 =      -59238493.0/1068277825; b7 =       181606767.0/758867731; b8 =       561292985.0/797845732; b9 =    -1041891430.0/1371343529; b10 =    760417239.0/1151165299; b11 =    118820643.0/751138087; b12 = -528747749.0/2220607170; b13 = 1.0/4;
                                   d1 =      13451932.0/455176632;                                                                                                    d6 =      -808719846.0/976000145; d7 =     1757004468.0/5645159321; d8 =       656045339.0/265891186; d9 =    -3867574721.0/1518517206; d10 =     465885868.0/322736535; d11 =     53011238.0/667516719; d12 =                  2.0/45;
}

void OdeDoPri87::step_ (double dt) {

    unsigned long i;

    //------------------------------------------------------------------
    ode_fun_(sol_, k_[0]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) soltemp_[i] = sol_[i] + dt*a21*k_[0][i];
    ode_fun_(soltemp_, k_[1]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) soltemp_[i] = sol_[i] + dt*(a31*k_[0][i]
                                                     + a32*k_[1][i]);
    ode_fun_(soltemp_, k_[2]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) soltemp_[i] = sol_[i] + dt*(a41*k_[0][i]
                                                     + a43*k_[2][i]);
    ode_fun_(soltemp_, k_[3]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) soltemp_[i] = sol_[i] + dt*(a51*k_[0][i]
                                                     + a53*k_[2][i]
                                                     + a54*k_[3][i]);
    ode_fun_(soltemp_, k_[4]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) soltemp_[i] = sol_[i] + dt*(a61*k_[0][i]
                                                     + a64*k_[3][i]
                                                     + a65*k_[4][i]);
    ode_fun_(soltemp_, k_[5]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) soltemp_[i] = sol_[i] + dt*(a71*k_[0][i]
                                                     + a74*k_[3][i]
                                                     + a75*k_[4][i]
                                                     + a76*k_[5][i]);
    ode_fun_(soltemp_, k_[6]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) soltemp_[i] = sol_[i] + dt*(a81*k_[0][i]
                                                     + a84*k_[3][i]
                                                     + a85*k_[4][i]
                                                     + a86*k_[5][i]
                                                     + a87*k_[6][i]);
    ode_fun_(soltemp_, k_[7]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) soltemp_[i] = sol_[i] + dt*(a91*k_[0][i]
                                                     + a94*k_[3][i]
                                                     + a95*k_[4][i]
                                                     + a96*k_[5][i]
                                                     + a97*k_[6][i]
                                                     + a98*k_[7][i]);
    ode_fun_(soltemp_, k_[8]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) soltemp_[i] = sol_[i] + dt*(a101*k_[0][i]
                                                     + a104*k_[3][i]
                                                     + a105*k_[4][i]
                                                     + a106*k_[5][i]
                                                     + a107*k_[6][i]
                                                     + a108*k_[7][i]
                                                     + a109*k_[8][i]);
    ode_fun_(soltemp_, k_[9]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) soltemp_[i] = sol_[i] + dt*(a111*k_[0][i]
                                                     + a114*k_[3][i]
                                                     + a115*k_[4][i]
                                                     + a116*k_[5][i]
                                                     + a117*k_[6][i]
                                                     + a118*k_[7][i]
                                                     + a119*k_[8][i]
                                                     + a1110*k_[9][i]);
    ode_fun_(soltemp_, k_[10]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) soltemp_[i] = sol_[i] + dt*(a121*k_[0][i]
                                                     + a124*k_[3][i]
                                                     + a125*k_[4][i]
                                                     + a126*k_[5][i]
                                                     + a127*k_[6][i]
                                                     + a128*k_[7][i]
                                                     + a129*k_[8][i]
                                                     + a1210*k_[9][i]
                                                     + a1211*k_[10][i]);
    ode_fun_(soltemp_, k_[11]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) soltemp_[i] = sol_[i] + dt*(a131*k_[0][i]
                                                     + a134*k_[3][i]
                                                     + a135*k_[4][i]
                                                     + a136*k_[5][i]
                                                     + a137*k_[6][i]
                                                     + a138*k_[7][i]
                                                     + a139*k_[8][i]
                                                     + a1310*k_[9][i]
                                                     + a1311*k_[10][i]);
    ode_fun_(soltemp_, k_[12]);

    //------------------------------------------------------------------
    for (i=0; i<neq_; i++) {
        solemb_[i] = sol_[i] + dt*(d1*k_[0][i]
                                 + d6*k_[5][i]
                                 + d7*k_[6][i]
                                 + d8*k_[7][i]
                                 + d9*k_[8][i]
                                 + d10*k_[9][i]
                                 + d11*k_[10][i]
                                 + d12*k_[11][i]);
        sol_[i] = sol_[i] + dt*(b1*k_[0][i]
                              + b6*k_[5][i]
                              + b7*k_[6][i]
                              + b8*k_[7][i]
                              + b9*k_[8][i]
                              + b10*k_[9][i]
                              + b11*k_[10][i]
                              + b12*k_[11][i]
                              + b13*k_[12][i]);
    }
}

} // namespace ode 
